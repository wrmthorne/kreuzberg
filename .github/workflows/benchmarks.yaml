name: Benchmarks

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Git branch to benchmark"
        required: false
        default: "main"
        type: string
      timeout:
        description: "Timeout per document in seconds"
        required: false
        default: "900"
        type: string
  pull_request:
    branches:
      - main
    paths:
      - 'tools/benchmark-harness/**'
      - '.github/workflows/benchmarks.yaml'

env:
  ITERATIONS: "3"
  PDFIUM_VERSION: "7578"
  PDFIUM_STATIC_VERSION: "7442b"
  ORT_VERSION: "1.23.2"
  MACOSX_DEPLOYMENT_TARGET: "14.0"
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short
  RUST_MIN_STACK: 16777216
  RUSTFLAGS: "-C strip=symbols"

permissions:
  contents: read

defaults:
  run:
    shell: bash

jobs:
  setup:
    name: Build harness + native libs
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    outputs:
      artifact-name: benchmarks-target
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Ensure benchmark harness exists
        run: scripts/benchmarks/ensure-benchmark-harness-exists.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-setup
          use-sccache: 'true'
          report-stats: 'true'

      - name: Cache PDFium
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium runtime
        run: scripts/download_pdfium_runtime.sh

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Cache benchmark harness
        uses: ./.github/actions/cache-benchmark-harness
        with:
          build-profile: release

      - name: Build FFI library
        uses: ./.github/actions/build-rust-ffi
        with:
          crate-name: kreuzberg-ffi
          build-profile: release

      - name: Log disk space before artifact upload
        run: scripts/ci/validate/show-disk-space.sh "Disk space before artifact upload"

      - name: Upload build artifacts (harness binary + FFI shared lib)
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-target
          path: |
            target/release/benchmark-harness
            target/release/libkreuzberg_ffi.so
            target/release/libkreuzberg_ffi.dylib
            target/release/kreuzberg_ffi.dll
            target/release/libkreuzberg_ffi.a
          retention-days: 7
          if-no-files-found: warn

      - name: Upload benchmark harness binary (for third-party jobs)
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-harness-binary
          path: |
            target/release/benchmark-harness
          retention-days: 7

      - name: Log disk space after artifact upload
        run: scripts/ci/validate/show-disk-space.sh "Disk space after artifact upload"

  bench-native:
    name: kreuzberg-rust (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-native
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-rust
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-rust-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-python:
    name: kreuzberg-python (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-python
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build Python bindings
        run: task python:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-python
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-python-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30



  bench-node:
    name: kreuzberg-node (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-node
          use-sccache: 'false'
          report-stats: 'true'

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Verify Node setup
        run: scripts/ci/benchmarks/verify-node-setup.sh "Node setup (async)"

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build Node bindings and install locally
        env:
          TARGET: x86_64-unknown-linux-gnu
        run: task node:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-node
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-node-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30


  bench-wasm:
    name: kreuzberg-wasm (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-wasm
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build WASM bindings
        run: task wasm:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-wasm
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-wasm-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30


  bench-ruby:
    name: kreuzberg-ruby (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-ruby
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Vendor kreuzberg core for Ruby
        run: scripts/ci/ruby/vendor-kreuzberg-core.sh

      - name: Build Ruby native gem
        env:
          PLATFORM: x86_64-linux
        run: task ruby:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-ruby
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-ruby-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-ruby-batch:
    name: kreuzberg-ruby-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-ruby-batch
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Vendor kreuzberg core for Ruby
        run: scripts/ci/ruby/vendor-kreuzberg-core.sh

      - name: Build Ruby native gem
        env:
          PLATFORM: x86_64-linux
        run: task ruby:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-ruby-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-ruby-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-go:
    name: kreuzberg-go (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-go
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache-dependency-path: packages/go/v4/go.sum

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Prime Go modules
        working-directory: packages/go/v4
        run: go mod download

      - name: Prime benchmark Go modules
        working-directory: tools/benchmark-harness/scripts
        run: go mod download

      - name: Build Go bindings
        run: task go:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-go
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          KREUZBERG_BENCHMARK_DEBUG: "true"
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-go-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-go-batch:
    name: kreuzberg-go-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-go-batch
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.x"
          cache-dependency-path: packages/go/v4/go.sum

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Prime Go modules
        working-directory: packages/go/v4
        run: go mod download

      - name: Prime benchmark Go modules
        working-directory: tools/benchmark-harness/scripts
        run: go mod download

      - name: Build Go bindings
        run: task go:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-go-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          KREUZBERG_BENCHMARK_DEBUG: "true"
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-go-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-java:
    name: kreuzberg-java (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-java
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Java
        uses: actions/setup-java@v4
        id: setup-java
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Build Java bindings
        run: task java:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-java
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-java-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-csharp:
    name: kreuzberg-csharp (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-csharp
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.0.x"

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Build C# bindings
        run: task csharp:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-csharp
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-csharp-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-elixir:
    name: kreuzberg-elixir (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-elixir
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.17.0"
          otp-version: "27.0"

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build Elixir bindings
        env:
          KREUZBERG_BUILD: "1"
        run: task elixir:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-elixir
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-elixir-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-elixir-batch:
    name: kreuzberg-elixir-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-elixir-batch
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: "1.17.0"
          otp-version: "27.0"

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build Elixir bindings
        env:
          KREUZBERG_BUILD: "1"
        run: task elixir:build:bindings

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-elixir-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-elixir-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-php:
    name: kreuzberg-php (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-php
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: ffi

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Build PHP bindings
        run: task php:build:ci

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-php
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-php-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-php-batch:
    name: kreuzberg-php-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.setup.outputs.artifact-name }}
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: benchmarks-php-batch
          use-sccache: 'true'
          report-stats: 'true'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: ffi

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Build FFI library
        id: ffi
        shell: bash
        run: |
          echo "=== Building FFI Library ==="
          echo "Building kreuzberg-ffi from source (with sccache fallback)"
          scripts/ci/actions/setup-rust/build-with-sccache-fallback.sh cargo build --release --package kreuzberg-ffi

      - name: Set library paths for FFI
        shell: bash
        run: |
          echo "PKG_CONFIG_PATH=${{ github.workspace }}/crates/kreuzberg-ffi:$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> "$GITHUB_ENV"

      - name: Build PHP bindings
        run: task php:build:ci

      - name: Run benchmark
        env:
          FRAMEWORK: kreuzberg-php-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-kreuzberg-php-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  # Third-party benchmarks are temporarily disabled while kreuzberg variants are stabilized.
  bench-docling:
    name: docling (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python

      - name: Run benchmark
        env:
          FRAMEWORK: docling
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-docling-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-docling-batch:
    name: docling-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: docling-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-docling-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-markitdown:
    name: markitdown (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: markitdown
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-markitdown-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-pandoc:
    name: pandoc (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
          pandoc --version

      - name: Run benchmark
        env:
          FRAMEWORK: pandoc
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-pandoc-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-unstructured:
    name: unstructured (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: unstructured
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-unstructured-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-tika:
    name: tika (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Java
        uses: actions/setup-java@v4
        id: setup-java
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Run benchmark
        env:
          FRAMEWORK: tika
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-tika-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-tika-batch:
    name: tika-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Java
        uses: actions/setup-java@v4
        id: setup-java
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Run benchmark
        env:
          FRAMEWORK: tika-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-tika-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-pymupdf4llm:
    name: pymupdf4llm (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: pymupdf4llm
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-pymupdf4llm-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-pdfplumber:
    name: pdfplumber (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: pdfplumber
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-pdfplumber-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-pdfplumber-batch:
    name: pdfplumber-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: pdfplumber-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-pdfplumber-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-mineru:
    name: mineru (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: mineru
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-mineru-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  bench-mineru-batch:
    name: mineru-batch (${{ matrix.mode }})
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        mode: [single-file, batch]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Free disk space
        run: scripts/ci/benchmarks/free-disk-space.sh

      - name: Download benchmark harness binary
        uses: actions/download-artifact@v4
        with:
          name: benchmark-harness-binary
          path: target/release

      - name: Restore benchmark binary permissions
        run: scripts/benchmarks/restore-binary-permissions.sh

      - name: Setup Python
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.11"
          cache-prefix: benchmark-python


      - name: Run benchmark
        env:
          FRAMEWORK: mineru-batch
          MODE: ${{ matrix.mode }}
          ITERATIONS: ${{ env.ITERATIONS }}
          TIMEOUT: ${{ github.event.inputs.timeout }}
        run: scripts/benchmarks/run-benchmark.sh

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-mineru-batch-${{ matrix.mode }}-${{ github.run_id }}
          path: benchmark-results/
          retention-days: 30

  aggregate-and-publish:
    name: Aggregate & Release Results
    needs: [setup, bench-native, bench-python, bench-node, bench-wasm, bench-ruby, bench-ruby-batch, bench-go, bench-go-batch, bench-java, bench-csharp, bench-elixir, bench-elixir-batch, bench-php, bench-php-batch, bench-docling, bench-docling-batch, bench-markitdown, bench-pandoc, bench-unstructured, bench-tika, bench-tika-batch, bench-pymupdf4llm, bench-pdfplumber, bench-pdfplumber-batch, bench-mineru, bench-mineru-batch]
    runs-on: ubuntu-latest
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: aggregate

      - name: Download all benchmark artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "benchmarks-*"
          path: benchmark-artifacts/
          merge-multiple: false

      - name: Validate artifacts before consolidation
        run: |
          set -euo pipefail

          echo "=== Validating benchmark artifacts ==="

          # Check if benchmark-artifacts directory exists and is not empty
          if [[ ! -d "benchmark-artifacts" ]]; then
            echo "ERROR: benchmark-artifacts directory does not exist"
            exit 1
          fi

          ARTIFACT_COUNT=$(find benchmark-artifacts -mindepth 1 -maxdepth 1 -type d | wc -l)
          if [[ $ARTIFACT_COUNT -eq 0 ]]; then
            echo "WARNING: No artifact directories found in benchmark-artifacts"
            echo "This may indicate that no benchmarks completed successfully"
            echo "Exiting gracefully - no data to consolidate"
            exit 0
          fi

          echo "Found $ARTIFACT_COUNT artifact directories"
          find benchmark-artifacts -mindepth 1 -maxdepth 1 -type d -exec basename {} \;

      - name: Consolidate results
        run: |
          set -euo pipefail

          # Check if we should skip (from validation step)
          if [[ ! -d "benchmark-artifacts" ]]; then
            echo "Skipping consolidation - no artifacts available"
            exit 0
          fi

          ARTIFACT_COUNT=$(find benchmark-artifacts -mindepth 1 -maxdepth 1 -type d | wc -l)
          if [[ $ARTIFACT_COUNT -eq 0 ]]; then
            echo "Skipping consolidation - no artifact directories found"
            exit 0
          fi

          echo "=== Consolidating benchmark results ==="

          # Find all artifact subdirectories
          ARTIFACT_DIRS=$(find benchmark-artifacts -mindepth 1 -maxdepth 1 -type d | tr '\n' ',' | sed 's/,$//')

          if [[ -z "$ARTIFACT_DIRS" ]]; then
            echo "ERROR: ARTIFACT_DIRS is empty after globbing"
            exit 1
          fi

          echo "Artifact directories: $ARTIFACT_DIRS"

          # Run consolidation
          cargo run --release --package benchmark-harness -- consolidate \
            --inputs "$ARTIFACT_DIRS" \
            --output consolidated-output/

          echo "Consolidation complete"
          ls -lh consolidated-output/

      - name: Validate aggregated data
        run: |
          set -euo pipefail

          echo "=== Validating aggregated benchmark data ==="

          AGGREGATED_FILE="consolidated-output/aggregated.json"

          # Check if aggregated.json exists
          if [[ ! -f "$AGGREGATED_FILE" ]]; then
            echo "ERROR: aggregated.json not found at $AGGREGATED_FILE"
            exit 1
          fi

          echo "Found aggregated.json ($(wc -c < "$AGGREGATED_FILE") bytes)"

          # Validate JSON structure using jq
          if ! jq empty "$AGGREGATED_FILE" 2>/dev/null; then
            echo "ERROR: aggregated.json is not valid JSON"
            exit 1
          fi

          echo "JSON validation passed"

          # Check for required fields (by_framework_mode)
          if ! jq -e '.by_framework_mode' "$AGGREGATED_FILE" > /dev/null 2>&1; then
            echo "ERROR: Required field 'by_framework_mode' not found in aggregated.json"
            exit 1
          fi

          echo "Required fields validated successfully"

          # Display data structure summary
          echo "Data structure summary:"
          jq 'keys' "$AGGREGATED_FILE" | head -20

      - name: Create GitHub Release with benchmark results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          echo "=== Creating GitHub Release with benchmark results ==="

          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA="${SHORT_SHA:0:7}"
          TAG="benchmark-run-${{ github.run_id }}"
          DATE=$(date -u +"%Y-%m-%d")

          # Create metadata file alongside aggregated data
          cat > consolidated-output/metadata.json <<EOF
          {
            "updated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF

          gh release create "$TAG" \
            --title "Benchmark Results ${DATE} (${SHORT_SHA})" \
            --notes "Comparative benchmark results from workflow run [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).

          **Commit:** ${{ github.sha }}
          **Date:** ${DATE}" \
            consolidated-output/aggregated.json \
            consolidated-output/metadata.json
