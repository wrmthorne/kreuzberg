version: "3"

includes:
  _cfg:
    taskfile: ../config/vars.yml
    internal: true
  _platforms:
    taskfile: ../config/platforms.yml
    internal: true

vars:
  PHP_VERSION: "8.2"

tasks:
  install:
    desc: Install PHP dependencies with Composer
    dir: packages/php
    cmds:
      - composer install

  setup:
    desc: Setup PHP dependencies with Composer (alias for install)
    dir: packages/php
    cmds:
      - task: php:install

  build:
    desc: Build PHP extension (uses {{.BUILD_PROFILE}})
    dir: packages/php
    cmds:
      - task: build:{{.BUILD_PROFILE | default "release"}}

  build:dev:
    desc: Build PHP extension in debug mode
    cmds:
      - cmd: cargo build --package kreuzberg-php
        platforms: [linux, darwin, windows]

  build:release:
    desc: Build PHP extension in release mode (optimized)
    cmds:
      - cmd: cargo build --release --package kreuzberg-php
        platforms: [linux, darwin, windows]

  build:ci:
    desc: Build PHP extension in CI mode (with debug info)
    cmds:
      - cmd: cargo build --release --package kreuzberg-php
        platforms: [linux, darwin, windows]
        env:
          RUSTFLAGS: '{{.RUSTFLAGS | default ""}} -C debuginfo=2'
      - cmd: bash scripts/ci/php/create-ci-php-ini.sh
        platforms: [linux, darwin, windows]

  test:
    desc: Run PHP tests with PHPUnit
    dir: packages/php
    cmds:
      - composer exec -- phpunit

  test:ci:
    desc: Run PHP tests in CI mode
    dir: packages/php
    cmds:
      - cmd: bash ../../scripts/ci/php/create-ci-php-ini.sh
        platforms: [linux, darwin, windows]
      - cmd: php -c ../../php-kreuzberg.ini vendor/bin/phpunit
        platforms: [linux, darwin, windows]

  test:quick:
    desc: Run PHP unit tests only (no integration tests)
    dir: packages/php
    cmds:
      - composer exec -- phpunit --testsuite=unit

  test:integration:
    desc: Run PHP integration tests
    dir: packages/php
    cmds:
      - composer exec -- phpunit --testsuite=integration

  test:coverage:
    desc: Run PHP tests with coverage report
    dir: packages/php
    cmds:
      - composer exec -- phpunit --coverage-html=coverage

  lint:
    desc: Lint PHP code with auto-fix (php-cs-fixer + phpstan)
    dir: packages/php
    cmds:
      - composer exec -- php-cs-fixer fix
      - composer exec -- phpstan analyse --memory-limit=512M

  lint:check:
    desc: Lint PHP code in check-only mode (php-cs-fixer + phpstan, no fixes)
    dir: packages/php
    cmds:
      - composer exec -- php-cs-fixer fix --dry-run --diff
      - composer exec -- phpstan analyse --memory-limit=512M

  lint:phpstan:
    desc: Run static analysis with PHPStan
    dir: packages/php
    cmds:
      - composer exec -- phpstan analyse --memory-limit=512M

  lint:phpstan:check:
    desc: Check static analysis with PHPStan in strict mode
    dir: packages/php
    cmds:
      - composer exec -- phpstan analyse --level=max --memory-limit=512M

  format:
    desc: Format PHP code with modifications (php-cs-fixer)
    dir: packages/php
    cmds:
      - composer exec -- php-cs-fixer fix

  format:check:
    desc: Check PHP code formatting without modifications (php-cs-fixer)
    dir: packages/php
    cmds:
      - composer exec -- php-cs-fixer fix --dry-run --diff

  clean:
    desc: Clean PHP build artifacts
    dir: packages/php
    cmds:
      - python -c "import shutil, glob, os; [shutil.rmtree(d, ignore_errors=True) for d in ['vendor', 'build', 'coverage']]; [os.remove(f) for f in glob.glob('*.so')]"

  update:
    desc: Update PHP dependencies
    dir: packages/php
    cmds:
      - echo "Updating PHP dependencies..."
      - composer update

  update:check:
    desc: Check for outdated PHP dependencies
    dir: packages/php
    cmds:
      - composer outdated

  e2e:generate:
    desc: Generate PHP E2E tests from fixtures
    dir: packages/php
    cmds:
      - cmd: bash scripts/task/e2e-generate.sh php
        platforms: [linux, darwin]
      - cmd: echo "E2E generation not yet supported on Windows - use WSL or CI"
        platforms: [windows]

  e2e:lint:
    desc: Lint PHP E2E code
    dir: e2e/php
    cmds:
      - composer exec -- php-cs-fixer fix --dry-run --diff
      - composer exec -- phpstan analyse --memory-limit=512M

  e2e:test:
    desc: Run PHP E2E tests
    dir: e2e/php
    cmds:
      - cmd: bash ../../scripts/ci/php/create-ci-php-ini.sh
        platforms: [linux, darwin, windows]
      - cmd: composer install --no-progress --prefer-dist
        platforms: [linux, darwin, windows]
      - cmd: php -c php-kreuzberg.ini vendor/bin/phpunit
        platforms: [linux, darwin]
      - cmd: php -c php-kreuzberg.ini vendor\bin\phpunit.bat
        platforms: [windows]

  e2e:verify:
    desc: Regenerate and validate PHP E2E suite (generate + lint + test)
    cmds:
      - task: e2e:generate
      - task: e2e:lint
      - task: e2e:test
